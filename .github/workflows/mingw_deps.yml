name: saldl mingw-w64 build deps
run-name: ${{ github.actor }} is running mingw-w64 build deps workflow ${{ github.repository }} using GitHub Actions (run_id=${{ github.run_id }}) 🚀
on:
  push:
    tags:
      - v**
    branches:
      - master
      - actions
    paths:
      - mingw-w64-build/mingw**
      - mingw-w64-build/build_deps.*
      - mingw-w64-build/.trigger
  pull_request:
    branches:
      - master
    paths:
      - mingw-w64-build/mingw**
      - mingw-w64-build/build_deps.*
      - mingw-w64-build/.trigger
  # only runs on master
  schedule:
    - cron: '30 18 * * 3'
jobs:
  build_arch_mingw_w64_pkg_deps:
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: update arch
        run: |
          pwd
          pacman -Syyu --noconfirm
      - name: install toolchain and base build deps
        run: |
          pwd
          pacman -S --noconfirm base-devel mingw-w64-toolchain git python zsh
      # NOTE: It's important to use the checkout action while git is in path
      #       to make sure it uses git, not the REST api, for checkout.
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Avoid 'dubious ownership' errors from git cli
        run: git config --global --add safe.directory '*'
      - run: echo "💡 The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "🖥️ The workflow is now ready to test your code on the runner."
      - name: build and install mingw-w64 deps packages
        run: |
          pwd
          cd mingw-w64-build
          pwd
          ./build_deps.zsh
          ls -l **/*curl*.pkg.*  **/*libevent*.pkg.*
      - name: upload artifact containing dep packages
        uses: actions/upload-artifact@v4
        with:
          name: saldl-mingw-64-pkg-deps
          overwrite: true
          if-no-files-found: error
          retention-days: 40
          path: |
            mingw-w64-build/*/mingw-w64-*.pkg.*
      - name: Append successful run run_id ${{ github.run_id }} to successful_runs
        run: |
          echo ${{ github.run_id }} >> mingw-w64-build/successful_runs
          echo 'set git user config'
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions (workflow commit)"
          echo 'Pre-add git status'
          git status --verbose
          git add mingw-w64-build/successful_runs
          echo 'Post-add git status'
          git status --verbose
          echo 'Commit the change'
          git commit -m "mingw-w64-build: Appending ${{ github.run_id }} to successful_runs"
          echo 'Push the change'
          git push origin ${{ github.ref_name }}
